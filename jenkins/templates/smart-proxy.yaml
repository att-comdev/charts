{{- if .Values.conf.smart_proxy.enable -}}
{{- $envAll := . }}
apiVersion: apps/v1
kind: Deployment
metadata:
  name: smart-proxy
spec:
  replicas: 1
  selector:
    matchLabels:
      application: smart-proxy
  template:
    metadata:
      labels:
        application: smart-proxy
      {{- if .Values.manifests.certificates }}
      annotations:
        {{- dict "envAll" $envAll "podName" "smart-proxy" "containerNames" (list "apache") | include "helm-toolkit.snippets.kubernetes_mandatory_access_control_annotation" | indent 8}}
      {{- end }}
    spec:
      containers:
      - name: apache
        image: {{ .Values.images.tags.httpd }}
        ports:
        - containerPort: 8888
        volumeMounts:
        - name: apache-config
          mountPath: /usr/local/apache2/conf/httpd.conf
          subPath: httpd.conf
      volumes:
      - name: apache-config
        configMap:
          name: smart-proxy-config
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: smart-proxy-config
data:
  httpd.conf: |
    ErrorLog /dev/stderr
    ServerRoot "/usr/local/apache2"
    Listen 8888
    LoadModule mpm_event_module modules/mod_mpm_event.so
    LoadModule authz_core_module modules/mod_authz_core.so
    LoadModule proxy_module modules/mod_proxy.so
    LoadModule proxy_connect_module modules/mod_proxy_connect.so
    LoadModule unixd_module modules/mod_unixd.so
    PidFile /usr/local/apache2/logs/httpd.pid
    User daemon
    Group daemon
    ProxyRequests On
    ServerName smart-proxy
    <Proxy "*">
        Require all granted
    </Proxy>
    ProxyRemoteMatch ^(.*\:\/\/)?([^.]+\.)*github\.(com|io) http://cso.proxy.att.com:8888
    ProxyRemoteMatch ^(.*\:\/\/)?([^.]+\.)*ghcr\.io http://cso.proxy.att.com:8888
    ProxyRemoteMatch ^(.*\:\/\/)?([^.]+\.)*githubusercontent\.com http://cso.proxy.att.com:8888
    ProxyRemoteMatch ^(.*\:\/\/)?pkg\.cfssl\.org http://cso.proxy.att.com:8888
    ProxyRemote * http://pxyapp.proxy.att.com:8080
    AllowCONNECT 443
---
apiVersion: v1
kind: Service
metadata:
  name: smart-proxy
spec:
  selector:
    application: smart-proxy
  ports:
  - protocol: TCP
    port: 8888
    targetPort: 8888
{{- end -}}